

# Про Uploader


Uploader - сервіс, створений для моніторингу визначених папок і при появі в них файлів завантаження цих файлів на FTP та виклик
скриптів для їх обробки.

Uploader створений на PHP, може працювати на версії від _________  

Принцип роботи сервіса полягає в запуску безкінечного циклу і в межах цього циклу виконання всіх необхідних функцій.

Скрипт можна викликати через браузер або з командної строки. При виклику через браузер оптціонально скрипт виводить інформацію про його роботу.

Так як скрипт може інколи аварійно закінчувати свою роботу, то передбачено механізм відновлення його роботи через cron, в якому задається
задача повторного запуску даного скрипта. Щоб уникнути запуску декількох копій скрипта, при свому запуску скрипт створює файл, в який при кожній
ітерації циклу записує мітку - timestamp. При запуску скрипта відбувається перевірка наявності файлу та зчитування мітки. Якщо мітка не 
поновлювалася певний визначений час, то вважається, що скрипт не працює і можна запускати його знову. 


## Функціонал реалізований на сайті Megalog

1. ### АРІ для завантаження інформації  в БД Megalog. 
    - запити та відповіді формуються в форматі JSON 
    - для цього необхідно послати запит за роутом /api/posts/add  методом post та вказати логін та пароль для доступу. 
    Аутентифікація здійснюється з допомогою middleware  MegalogMiddleware. Користувач, який пройшов аутентифікацію, може записувати 
    інформацію в лог. Зразок запиту на запис інформації:
                {
                     "result": 0,
                     "files":  ["file1","file2","file3"],
                     "error": "Помилка запуску скрипта upload -> error send FTP ",
                     "categoty_id": 3,
                     "alias":  "online",
                     "station_id": 1,
                     "login": "yourlogin",
                     "password": "yourpassword"
                }
    - якщо користувач не пройшов аутентифікацію, вертається помилка 401 Unauthorized та  відповідь  
    {
        "error": "true", 
        "message": "Unauthorized Error", 
        "login": "login", 
        "password": "password" 
    }
    - метод addPost() - додавання інформації про подію в БД. 
    Приймає методом POST дані для додаваня в БД, проводить валідацію та запис інформації в БД. 
    Вертає:
        - JSON представлення моделі в разі успішного додавання запису в БД, 
        - разі помилки валідації: вертається помилка 400 - Bad Request та відповідь , в якій наявні елементи 
        {
            "error": "true",
            "message": масив помилок валідації, що вертає метод errors() об"єкту validator ,
        }     
        - в разі помилки запису в БД  вертається помилка 503 - Service Unavailable та відповідь , в який наявні елементи 
           {
                "error": "true",
                "message": повідомлення про помилку, що вертає метод getMessage() об"єкта класу Exception,
           }     
        
2. ###Побудова графіку згідно заданих параметрів.
    - Виконується шляхом AJAX запиту за роутом /api/graf  методом post у форматі JSON з параметрами
      для побудови графіку.
    - метод showGraf() проводить валідацію вхідних даних, обраховує необхідну інформацію та вертає JSON об"єкт з даними для 
      побудови графіку плагином chart.js
    - обрані в формі параметри для побудови графіку записуються в Cookies і в подальщому відновлюються при завантаженні сторінки.   

3. ### Вивід інформації з логу з можливістю сортування та певним попереднім відбором.
    - на головній сторінці задається автостанція і дата логу 
    - при натисканні кнопки "ПЕРЕГЛЯНУТИ" направляється на роут /postsfromday і екшен getPostsFromDay() в якому відбувається 
        * валідація вхідних даних,
        * відбір необхідних даних для відображення,
        * якщо це AJAX запит - то вертається html код view table_posts.blade.php, інакше відпрацьовує view posts.blade.php.
    - на сторінці виводиться лог з пагінацією, та є можливість сортувати його по кожній з колонок.
    - сортування відбуваєть шляхом надсилання AJAX запиту  на екшен getPostsFromDay(), який вертає відсортований лог з відповідною
      пагінацією 
4. ### Відображення інформерів про деякі події з можливістю перегляду самих записів про ці події.
    - на головній сторінці відображається кількість вдалих синхронізацій та кількість помилок за поточну добу з можливістю 
      переглянути список відповідних помилок.
5. ### Аутентифікація.
    - стандартна аутентифікація Laravel.
    - проходить тільки користувач адміністратор, який може після аутентифікації додавати користувачів, що зможуть працювати
    з АРІ.
6. ### Повідомлення на e-mail та відправка sms в разі відсутності подій певний вказаний в конфігурації час.
    - перехід по роуту \control викликає метод control() контролера IndexController.
    - в файлі \config\megalog.php знаходяться налаштування для роботи екшена - для кожного виду синхронізації задаються
      наступні параметри 
        * години доби, протягом яких ведеться моніторинг,
        * кількість годин відсутності завантажень коли висилається попередження
    - при кожному виклику метода control() відбувається аналіз по кожному виду синхронізації, скільки часу були відсутні 
      записи про успішну синхронізацію в лозі в межах визначених годин доби. Якщо цей час перевищює допустиму межу, то 
      відбувається відправка повідомлення на вказаний в файлі конфігурації e-mail, та в разі встановлення дозволу на 
      відправку СМС також відправка СМС на вказаний в конфігурації номер (чи номери) телефону. СМС відправляється через
      сервіс Турбо СМС з використанням плагіну [laravel-turbo-sms](https://github.com/mkuzmych/laravel-turbosms).
      Повідомлення про відсутність синхронізації відсилається тільки двічі.
      Якщо синхронізацція відновилася, то про це також повідоляється аналогічним чином. Повідомлення про відновлення синхронізації,
       яка не праціювала більше вказаних в файлі конфігурації кількість діб не відбувається.    


